file kernel
set pagination off
target remote localhost:1234
layout src

# Set breakpoints for MMU testing
b main
b identity_map_kernel
b loadPageDirectory
b enable_paging
b map_pages

# Define helper commands for MMU debugging
define dump_page_directory
    printf "=== Page Directory Dump ===\n"
    set $pd = (struct page_directory_entry *)pd
    set $i = 0
    while $i < 10
        if $pd[$i].present
            printf "PD[%d]: present=%d, rw=%d, frame=0x%x\n", $i, $pd[$i].present, $pd[$i].rw, $pd[$i].frame
        end
        set $i = $i + 1
    end
end

define dump_page_table
    printf "=== Page Table Dump (first 20 entries) ===\n"
    set $pt = (struct page *)pt
    set $i = 0
    while $i < 20
        if $pt[$i].present
            printf "PT[%d]: present=%d, rw=%d, frame=0x%x, dirty=%d\n", $i, $pt[$i].present, $pt[$i].rw, $pt[$i].frame, $pt[$i].dirty
        end
        set $i = $i + 1
    end
end

define check_cr3
    # Read CR3 register value
    printf "=== Control Registers ===\n"
    printf "Checking CR3 register...\n"
    # Note: We can't directly read CR3 from GDB, but we can check if loadPageDirectory was called
    printf "Page directory address should be: %p\n", &pd
end

define check_paging_enabled
    printf "=== Paging Status ===\n"
    printf "If you see this message after enable_paging(), paging is working!\n"
    printf "If the system crashes/resets, there's a page table issue.\n"
end

define test_virtual_memory
    printf "=== Virtual Memory Test ===\n"
    printf "Testing virtual address 0x400000...\n"
    # This will help us see if the virtual memory mapping worked
    set $test_addr = 0x400000
    printf "Virtual address 0x%x should be mapped\n", $test_addr
end

printf "=== MMU Testing GDB Script Loaded ===\n"
printf "Available commands:\n"
printf "  dump_page_directory - Show page directory entries\n"
printf "  dump_page_table     - Show page table entries\n"
printf "  check_cr3          - Check CR3 register setup\n"
printf "  check_paging_enabled - Verify paging is working\n"
printf "  test_virtual_memory - Test virtual memory mapping\n"
printf "\n"
printf "Starting execution...\n"
c
